{% props field, label = null, help = null, type = null, valid = false %}

{# determine the type to use #}
{% for prefix in field.vars.block_prefixes|reverse %}
    {% if not type and prefix in ['hidden', 'textarea', 'checkbox', 'radio', 'button', 'submit', 'email', 'file', 'choice', 'date'] %}
        {% set type = prefix %}
    {% endif %}
{% endfor %}

{% set compound = field.vars.compound|default(false) %}
{% set tag = compound ? 'fieldset' : 'div' %}
{% set label = label ?: field.vars.label ? field.vars.label : field.vars.name|humanize %}
{% set help = help ?: field.vars.help|default %}
{% set errors = field.vars.errors|default([]) %}
{% set valid = valid ?: field.vars.submitted|default(false) and field.vars.valid|default(false) %}

{% set widgetAttr = {
    id: field.vars.id,
    name: field.vars.full_name,
    disabled: field.vars.disabled|default(false),
    required: field.vars.required|default(false),
    'aria-describedby': help ? field.vars.id ~ '-help' : false,
} %}

<{{ tag }}{{ attributes.defaults({
    class: html_classes(
        'ui-form-row',
        type ? 'ui-form-row-'~type,
        {
            'is-valid': valid,
            'has-error': errors,
        },
    ),
    hidden: 'hidden' == type,
}) }}>
    {% block content %}
        {% block label %}
            {% if compound %}
                <legend class="ui-form-label">{{ label }}</legend>
            {% elseif type not in ['button', 'submit', 'hidden'] %}
                <twig:Form:Label :field="field">{{ label }}</twig:Form:Label>
            {% endif %}
        {% endblock %}

        {% block widget %}
            {% if compound %}
                {% for child in field.children %}
                    <twig:Form:Row :field="child" />
                {% endfor %}
            {% elseif type == 'textarea' %}
                <twig:Form:Textarea :field="field" {{ ...widgetAttr }} />
            {% elseif type == 'choice' %}
                <twig:Form:Select :field="field" {{ ...widgetAttr }} />
            {% elseif type in ['button', 'submit'] %}
                <twig:Button :type="type" {{ ...widgetAttr }}>{{ label }}</twig:Button>
            {% else %}
                <twig:Form:Input :field="field" :type="type" {{ ...widgetAttr }} />
            {% endif %}
        {% endblock %}

        {% block errors %}
            {% if errors %}
                <twig:Form:Errors :field="field" />
            {% endif %}
        {% endblock %}

        {% block help %}
            {% if help %}
                <twig:Form:Help :field="field" :value="help" />
            {% endif %}
        {% endblock %}
    {% endblock %}

    {% do field.setRendered %}
</{{ tag }}>
